#!/bin/sh

set -eu

ROOTDIR="$(pwd)"
export CC=clang
export CXX=clang++

MY_INSTALL_DIR="$ROOTDIR/out/$LLVM_RELEASE_BASENAME"
mkdir -p $MY_INSTALL_DIR

mkdir -p "$ROOTDIR/out/build-zlib-host"
cd "$ROOTDIR/out/build-zlib-host"
cmake "$ROOTDIR/zlib" \
    -G Ninja \
    -DCMAKE_INSTALL_PREFIX="$MY_INSTALL_DIR" \
    -DCMAKE_PREFIX_PATH="$MY_INSTALL_DIR" \
    -DCMAKE_BUILD_TYPE=Release
cmake --build . --target install

mkdir -p "$ROOTDIR/out/build-zstd-host"
cd "$ROOTDIR/out/build-zstd-host"
cmake "$ROOTDIR/zstd" \
    -G Ninja \
    -DCMAKE_INSTALL_PREFIX="$MY_INSTALL_DIR" \
    -DCMAKE_PREFIX_PATH="$MY_INSTALL_DIR" \
    -DCMAKE_BUILD_TYPE=Release
cmake --build . --target install

mkdir -p "$ROOTDIR/out/build-llvm-host"
cd "$ROOTDIR/out/build-llvm-host"
cmake "$ROOTDIR/llvm" \
    -G Ninja \
    -DCMAKE_INSTALL_PREFIX="$MY_INSTALL_DIR" \
    -DCMAKE_PREFIX_PATH="$MY_INSTALL_DIR" \
    -DCMAKE_BUILD_TYPE="$CMAKE_BUILD_TYPE" \
    -DLLVM_PARALLEL_LINK_JOBS=1 \
    -DLLVM_ENABLE_BINDINGS=OFF \
    -DLLVM_ENABLE_LIBEDIT=OFF \
    -DLLVM_ENABLE_LIBPFM=OFF \
    -DLLVM_ENABLE_LIBXML2=OFF \
    -DLLVM_ENABLE_OCAMLDOC=OFF \
    -DLLVM_ENABLE_PLUGINS=OFF \
    -DLLVM_ENABLE_PROJECTS="lld;clang" \
    -DLLVM_ENABLE_TERMINFO=OFF \
    -DLLVM_ENABLE_Z3_SOLVER=OFF \
    -DLLVM_ENABLE_ZSTD=OFF \
    -DLLVM_INCLUDE_UTILS=OFF \
    -DLLVM_INCLUDE_TESTS=OFF \
    -DLLVM_INCLUDE_EXAMPLES=OFF \
    -DLLVM_INCLUDE_BENCHMARKS=OFF \
    -DLLVM_INCLUDE_DOCS=OFF \
    -DLLVM_TOOL_LLVM_LTO2_BUILD=OFF \
    -DLLVM_TOOL_LLVM_LTO_BUILD=OFF \
    -DLLVM_TOOL_LTO_BUILD=OFF \
    -DLLVM_TOOL_REMARKS_SHLIB_BUILD=OFF \
    -DCLANG_BUILD_TOOLS=OFF \
    -DCLANG_INCLUDE_DOCS=OFF \
    -DCLANG_INCLUDE_TESTS=OFF \
    -DCLANG_TOOL_CLANG_IMPORT_TEST_BUILD=OFF \
    -DCLANG_TOOL_CLANG_LINKER_WRAPPER_BUILD=OFF \
    -DCLANG_TOOL_C_INDEX_TEST_BUILD=OFF \
    -DCLANG_TOOL_ARCMT_TEST_BUILD=OFF \
    -DCLANG_TOOL_C_ARCMT_TEST_BUILD=OFF \
    -DCLANG_TOOL_LIBCLANG_BUILD=OFF
cmake --build . --target install

DEPLOY_FILE="$LLVM_RELEASE_BASENAME.7z"
7z a -t7z -m0=lzma2 -mx=9 -mfb=64 -md=32m -ms=on $DEPLOY_FILE $MY_INSTALL_DIR

echo "DEPLOY_FILE=$DEPLOY_FILE" >> $GITHUB_OUTPUT
